<tool id="humann2" name="HUMAnN2" version="0.1.0">
    <description>to profile the presence/absence and abundance of microbial pathways</description>

    <requirements>
        <requirement type="package" version="2.2.4">bowtie2</requirement>
        <requirement type="package" version="2.0">metaphlan2</requirement>
        <requirement type="package" version="0.6.13">diamond</requirement>
        <requirement type="package" version="2.0">humann2</requirement>
    </requirements>

    <stdio>
        <exit_code range="1:" />
    </stdio>

    <version_command>
<![CDATA[
    humann2 --version
]]>
    </version_command>

    <command><![CDATA[
        humann2 
            -i "$input_file"
        
            #if $taxonomic_profile.test:
                --taxonomic-profile $taxonomic_profile.file
            #end if

            --evalue $e_value
            --identity-threshold $identity
            --prescreen-threshold $prescreen

            --pathways $pathways

            #set $data_table = dict([(_[0], _[2]) for _ in $protein_database.input.options.tool_data_table.data])
            #set $db = $protein_database.value
            --protein-database $data_table[$db]

            #set $data_table = dict([(_[0], _[2]) for _ in $nucleotide_database.input.options.tool_data_table.data])
            #set $db = $nucleotide_database.value
            --nucleotide-database $data_table[$db]

            --metaphlan \${METAPHLAN2_DIR}/
            --metaphlan-options "-t rel_ab"

            --threads \${GALAXY_SLOTS:-4}

            --translated-alignment diamond

            --xipe $xipe
            --minpath $minpath
            --pick-frames $pick_frames

            -o "output"
            --output-format $output_format
            --output-max-decimals $output_max_dec
            --output-basename "humann2"            
    ]]></command>

    <inputs>
        <param name="input_file" type="data" format="fastq,fasta,sam,bam,biom" 
            label="Input sequence file" help=""/>

        <conditional name="taxonomic_profile">
            <param name='test' type='boolean' checked="false" truevalue='true' 
                falsevalue='false' label="Use a custom taxonomic profile?" 
                help="The file must have been created by MetaPhlan"/>
            <when value="true">
                <param name="file" type="data" format="" label="Taxonomic profile 
                    file" help=""/>
            </when>
            <when value="false" />
        </conditional>

        <param name="nucleotide_database" label="Nucleotide database" type="select" >
            <options from_data_table="humann2_nucleotide_database" />
        </param>

        <param name="protein_database" label="Protein database" type="select" >
            <options from_data_table="humann2_protein_database" />
        </param>

        <param name="e_value" type="float" min="0" max="10" value="1" 
            label="E-value threshold to use with the translated search" 
            help="(--evalue)"/>
        <param name="identity" type="integer" min="0" max="100" value="40" 
            label="Identity threshold for alignments" help="(--identity-threshold)"/>
        <param name="prescreen" type="float" min="0" max="1" value="0.01" 
            label="Minimum percentage of reads matching a species" 
            help="(--prescreen-threshold)"/>

        <param name='pathways' type="select" label="Database to use for pathway computations"
            help="(--pathways)">
            <option value="metacyc" selected="true">MetaCyc</option>
            <option value="unipathway">UniPathway</option>
        </param>

        <param name='xipe' type='boolean' checked="false" truevalue='on' 
            falsevalue='off' label="Use xipe computation?" help="(--xipe)"/>
        <param name='minpath' type='boolean' checked="true" truevalue='on' 
            falsevalue='off' label="Use minpath computation?" help="(--minpath)"/>
        <param name='pick_frames' type='boolean' checked="true" truevalue='on' 
            falsevalue='off' label="Use pick frames computation?" 
            help="(--pick-frames)"/>

        <param name='output_format' type="select" label="Format of the output files"
            help="(--output-format)">
            <option value="tsv" selected="true">TSV</option>
            <option value="biom">BIOM</option>
        </param>
        <param name="output_max_dec" type="integer" min="0" max="100" value="10" 
            label="Number of decimals to output" help="(--output-max-decimals)"/>
    </inputs>

    <outputs>
    </outputs>

    <tests>
    </tests>

    <help><![CDATA[
        **What it does**

        HUMAnN is a pipeline for efficiently and accuretly profiling the presence/absence and abundance of microbial pathways in a community from metagenomic or metatranscriptomic sequencing data. `Read more about the tool <http://huttenhower.sph.harvard.edu/humann2/manual>`_.

        ----- 

        **Input**

        Usually, a single file is the input. It must be one of the following types:

            - filtered shotgun sequencing metagenome file (fastq, fastq.gz, fasta, or fasta.gz format)
            - alignment file (sam, bam or blastm8 format)
            - gene table file (tsv or biom format)

        A file with taxonomic profiles can also be given to be use to select pangenomes in ChocoPhlan database.

        ----- 

        **Outputs**

        HUMAnN creates three output files:

            - Gene family abundance
            - Pathway abundance
            - Pathway coverage

        and intermediate temp files.

    ]]></help>

    <citations>
    </citations>
</tool>